!function(){function report_mes(){return external.lego?external.lego.Common&&external.lego.Common.Report?external.lego.Common.Report:external.lego.Report?external.lego.Report:void 0:function(){console.log("NOT IN LIEBAO BROWSER!")}}var QUEUE=[];WLS=window.localStorage,TODAY=(new Date).toLocaleDateString().match(/\d+/g).join("/"),OpenTime=(new Date).getTime(),tempTime=OpenTime;var bolToday=!1,new_today;WLS.GA||(WLS.GA="{}"),WLS.hasWarningCity?"":WLS.hasWarningCity="",WLS.TipsDay?"":WLS.TipsDay="",WLS.WarningState?"":WLS.warningState="yes",WLS.ForecastState?"":WLS.ForecastState="yes",WLS.OpenTime=OpenTime,WLS.tempTime=tempTime,function(){var e=WLS.cityCode;e&&!/^\d+$/.test(e)&&WLS.removeItem("cityCode")}();var send_new_report=report_mes();WeatherUnit={init:function(){this.resetWLS(),this.getIP(),this.report_url(),this.listenEvent()},resetWLS:function(){TODAY!=WLS.TipsDay&&(WLS.hasWarningCity="")},runQUEUE:function(){QUEUE.length>0&&"function"==typeof QUEUE[0]&&QUEUE[0]()},getIP:function(){$.ajax({url:"http://api.liebao.cn/mars/index.php?r=legoWeather/getcity",type:"get",data:"",timeout:3e3,success:function(e){e=JSON.parse(e),WeatherUnit.getLocation(e.data[1])},error:function(e){setTimeout(function(){WeatherUnit.getIP()},4e3)}})},getLocation:function(e){$.ajax("http://weather.123.duba.net/weatherinfo/?callback=getDuBaData",{type:"get",data:"",dataType:"text",timeout:5e3,success:function t(e){var a,t=!0;e=e.replace(/^getDuBaData\(|\)$/g,"");try{a=JSON.parse(e)}catch(o){t=!1}if(t=t&&a.weatherinfo&&a.weatherinfo.city&&/^\d+$/.test(String(a.weatherinfo.cityid)),!t)return setTimeout(function(){WeatherUnit.getIP()},2e4);if(!WLS.cityName||!WLS.cityCode){WLS.AutoCityName=a.weatherinfo.city.replace("市","")||"北京";WLS.cityCode=a.weatherinfo.cityid||WeatherUnit.getLocationCode(AutoCityName)||101010100}},error:function(){setTimeout(function(){WeatherUnit.getIP()},2e4)}})},getLocationCode:function(e){var t=new RegExp('\\"'+e+'\\"\\,\\"id\\"\\:\\"(\\d.*?)\\"'),a="";try{a=JSON.stringify(CITY_DATA).match(t)[1]}catch(o){a=101010100}return a},getWeatherData:function(e){$.ajax("http://weather.api.liebao.cn/index.php?r=weather/GetXiaomiWeatherData&city_id="+WLS.cityCode,{type:"get",data:"",timeout:3e3,success:function(t){t=JSON.parse(t.match(/\{.*\}/g)),WLS.wData=JSON.stringify(t.msgdata),e(t)},error:function(){e(!1)}})},listenEvent:function(){var e=this;chrome.extension.onMessage.addListener(function(t,a,o){"weather_data"==t.act?e.getWeatherData(function(e){if(0==e){var t={};t.bol=e,t.stats="error",chrome.extension.sendMessage("",t,function(){})}else{var a=e;a.act="weather_data",chrome.extension.sendMessage("",a,function(){})}}):"show_city"==t.act?WLS.showType=1:"show_detail"==t.act?WLS.showType=2:"show_main"==t.act?WLS.showType=0:"show_settings"==t.act&&(WLS.showType=3),"function"==typeof o&&"weather_data"!=t.act&&o()}),chrome.browserAction.onClicked.addListener(function(){chrome.browserAction.setPopup({popup:"popup.html"}),WLS.showType="0",external.lego.browser.Popup('{"popup":"0"}')}),chrome.tabs.onUpdated.addListener(function(e,t,a){if("complete"==t.status)for(var o in URL)if(URL[o].length>0&&URL[o].length<2){var n=new RegExp(URL[o][0]),r=n.test(a.url);if(r){var i=JSON.parse(WLS.GA);i[o]?i[o]=1*i[o]+1:i[o]=1,WLS.GA=JSON.stringify(i);break}}else if(URL[o].length>=2){for(var s=0;s<URL[o].length;s++){var c=new RegExp(URL[o][s]),p=c.test(a.url);if(1==p)break}if(p){var i=JSON.parse(WLS.GA);i[o]?i[o]=1*i[o]+1:i[o]=1,WLS.GA=JSON.stringify(i);break}}})},forecastInit:function(){var e=new Date(TODAY+" 16:00:00").getTime(),t=(new Date).getTime(),a="";e>t?(clearTimeout(a),a=setTimeout(function(){WeatherUnit.runQUEUE()},e-t)):(clearTimeout(a),a=setTimeout(function(){WeatherUnit.runQUEUE()},1e4))},checkWarning2:function(){if("off"==WLS.warningState)return!1;var e=WLS.cityCode;$.ajax("http://message.lego.liebao.cn:8080/msg/get?key=weather_yj_"+e+"&mid=0&pmid=0",{type:"get",data:"",timeout:3e3,success:function(e){return hasData=JSON.parse(e),null==hasData.data?!1:(e=JSON.parse(e.match(/\{.*\}/g)),e=JSON.stringify(e.data),e=JSON.parse(e.match(/\{.*\}/g)),e=JSON.stringify(e.msgs),e=JSON.parse(e),e=e[0],e=JSON.parse(e.match(/\{.*\}/g)),e=JSON.stringify(e.msg),e=JSON.parse(e.match(/\".*\"/g)),e=JSON.parse(e),void 0)},error:function(){}});var t=270,a=new WebSocket("ws://message.lego.liebao.cn:51068/sub?key=weather_yj_"+e+"&heartbeat="+t);a.onopen=function(e){},a.onclose=function(e){WeatherUnit.checkWarning2()},a.onmessage=function(e){console.log(e);var o=e.data;0===o.indexOf("+h")?setTimeout(function(){a.send("h")},1e3*t):0===o.indexOf("-")||(data=JSON.parse(o.match(/\{.*\}/g)),data=JSON.stringify(data.msg),data=JSON.parse(data.match(/\".*\"/g)),data=JSON.parse(data))},a.onerror=function(e){console.log(e)},chrome.extension.onMessage.addListener(function(e,t,o){"city_sele"==e.act&&a.close()})},openWarning:function(e){if(WLS.TipsDay==TODAY)return!1;moment.lang("zh-cn");var t=moment().format("LL"),a=WLS.hasWarningCity||"";e.act="openWarning",(t!=a.split("@")[0]||-1==a.indexOf(e.title))&&(WeatherUnit.popUp_warning(),WLS.hasWarningCity+=t+"@"+e.title,TipsState=TODAY)},sortTemp:function(e){return e=e.split("~").sort(function(e,t){return parseInt(e)-parseInt(t)}).join("~")},forecast:function forecast(){var reCheck="";if("no"==WLS.weatherForecast)return!1;var forecastDay=(new Date).toLocaleDateString().match(/\d+/g).join("/")+"-"+WLS.cityCode;WLS.forecastDay!=forecastDay&&!function(){var dealTomorrowDate=function(e){var t={};t.tem=WeatherUnit.sortTemp(e.msgdata.yb.weatherinfo.temp2).replace(/℃/,""),t.weatherinfo=e.msgdata.yb.weatherinfo.weather2,t.act="openForecast",chrome.tabs.query({},function(e){for(var a=e.length;a--;)send_report(137,5,"&value1="+WLS.cityCode),chrome.tabs.sendMessage(e[a].id,t,function(){})})};$ajax("http://weather.api.liebao.cn/index.php?r=weather/GetXiaomiWeatherData&city_id="+WLS.cityCode,{type:"get",data:"",timeout:3e3,success:function success(data){var getXiaomiData=dealTomorrowDate;eval(data)},error:function(){}}),console.log("set close"),CloseWarning=setTimeout(function(){WeatherUnit.doClose()},RemainTime),WLS.forecastDay=forecastDay}()},popupWeather:function(){function e(){var e=(new Date(TODAY+" 00:00:00").getTime()+864e5,(new Date).getTime());1e3*Math.floor(900*Math.random());e>=a&&o>=e?WeatherUnit.popupNotPm():e>=n&&r>=e&&WeatherUnit.popupPm()}var t=this,a=new Date(TODAY+" 16:00:00").getTime(),o=new Date(TODAY+" 23:59:59").getTime(),n=new Date(TODAY+" 02:00:00").getTime(),r=new Date(TODAY+" 12:00:00").getTime();"yes"==WLS.ForecastState&&chrome.tabs.onCreated.addListener(function(i){"yes"==WLS.ForecastState&&chrome.windows.getLastFocused(function(i){if("popup"!=i.type){var s=(new Date).getTime();WLS.checkTime=s,(s>=a&&o>=s&&WLS.popupRecord!=TODAY||s>=n&&r>=s&&WLS.popupRecord!=TODAY)&&(tempTime==OpenTime&&s>=OpenTime+6e4||s>=tempTime+9e5)&&(tempTime=s,WLS.tempTime=tempTime,t.getWeatherData(function(a){if(console.log(a),0==a)WLS.getDataSuccess=!1;else{WLS.getDataSuccess=!0;var o=JSON.stringify(a);try{var n=JSON.parse(o)}catch(r){return console.log("天气error"),!1}n&&(WLS.shuju=o,t.newsContent(function(t){if(0==t){var a=JSON.stringify([]);WLS.newsC=a,e()}else{var a=JSON.stringify(t);try{var o=JSON.parse(a)}catch(n){return console.log("新闻error"),!1}o&&(WLS.newsC=a,e())}}))}}))}})})},newsContent:function(e){$.ajax("http://news.duba.com/json/lbapi.html",{type:"get",data:"",dataType:"json",timeout:3e3,success:function(t){e(t)},error:function(){e(!1)}})},popupPm:function(){window.setTimeout(function(){WLS.popupRecord&&WLS.popupRecord==TODAY||(chrome.browserAction.setPopup({popup:"weather1.2.0.html"}),bolToday?WLS.popupRecord=new_today:WLS.popupRecord=TODAY,chrome.tabs.getSelected(function(e){re=/http:\/\/([^\/]+)\//i,h=e.url.match(re),u=h[1],console.log(u),send_new_report(137,101,"&value4="+u)}),send_new_report(137,101,"&value1=1&value2=0&value3="+WLS.cityCode),external.lego.browser.Popup('{"popup":"1"}'),chrome.browserAction.setPopup({popup:"popup.html"}))},1e3)},popupNotPm:function(){window.setTimeout(function(){return WLS.popupRecord&&WLS.popupRecord==TODAY?void 0:"yes"!=WLS.ForecastState?!1:(chrome.browserAction.setPopup({popup:"weather1.2.0_2.html"}),WLS.popupRecord=TODAY,chrome.tabs.getSelected(function(e){re=/http:\/\/([^\/]+)\//i,u=h[1],console.log(u),send_new_report(137,102,"&value4="+u)}),send_new_report(137,102,"&value1=1&value2=0&value3="+WLS.cityCode),external.lego.browser.Popup('{"popup":"1"}'),chrome.browserAction.setPopup({popup:"popup.html"}),void 0)},1e3)},report_url:function(){if("{}"!=WLS.GA&&void 0!=WLS.GA){var e="",t=JSON.parse(WLS.GA);for(var a in t)e+="&"+a+"="+t[a];send_new_report(132,50,e),WLS.GA="{}"}}},WeatherUnit.init()}();